########################################
# A) Network & Security
########################################

# Listen on all interfaces ONLY inside a private network.
bind 0.0.0.0
port 6379
protected-mode yes

# Use ACLs (preferred). Replace the password below.
# Disable default user and create an "app" user with full access.
user default off
user app on >yattalunga allcommands allkeys &*


# Keep idle TCP connections healthy (seconds).
tcp-keepalive 300

########################################
# B) Persistence â€” AOF (durable instance)
########################################

# Data directory (MUST be a Docker volume).
dir /data

# Enable Append Only File for durability.
appendonly yes

# Balance of performance & durability:
# - always  : fsync every write (safest, slowest)
# - everysec: fsync once per second (recommended)
# - no      : OS decides when to flush (fastest, risky)
appendfsync everysec

# Use RDB preamble in AOF to speed up restarts and shrink file size.
aof-use-rdb-preamble yes

# AOF filenames/dirs (keep defaults, but set explicitly for clarity).
appendfilename "appendonly.aof"
appenddirname "appendonlydir"

# Automatic AOF rewrite to control file growth.
# Rewrite triggers when AOF size is +100% (2x) since last rewrite and >= 64MB.
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# If the AOF fsync fails (e.g., disk error), by default Redis keeps accepting writes
# and logs the error. Consider promoting this to an alert in monitoring.
# (No direct config here; just ensure you monitor aof_last_write_status).

########################################
# D) Memory Management
########################################

# For this durable instance we NEVER want Redis to evict keys automatically.
# If memory limit is reached, writes should fail instead of losing data.
maxmemory-policy noeviction

# (Optional) Set an explicit memory limit.
# If omitted, Redis uses all available system memory.
# You can uncomment and adjust if you want a hard ceiling:
# maxmemory 2gb

########################################
# E) Monitoring & Logging
########################################

# Logging level: choose between debug, verbose, notice, warning.
# "notice" is good default for production.
loglevel notice

# Slowlog: log commands that take longer than N microseconds.
slowlog-log-slower-than 10000
slowlog-max-len 256

# Latency monitor: log spikes above threshold (in ms).
latency-monitor-threshold 100

# Syslog integration (optional). Can be enabled if your infra uses syslog.
# syslog-enabled yes
# syslog-ident redis

########################################
# F) Misc / Production Hardening
########################################

# Limit number of connected clients (protects from overload).
maxclients 10000

# Increase TCP backlog (queue of pending connections).
tcp-backlog 511

# Client output buffer limits:
# Prevent misbehaving clients (like subscribers) from eating all RAM.
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60